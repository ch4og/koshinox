#!/usr/bin/env -S GUILE_AUTO_COMPILE=0 guix shell maak -- env -S GUILE_AUTO_COMPILE=0 maak -f
;; -*- mode: scheme -*-
;; SPDX-FileCopyrightText: 2026 Nikita Mitasov <me@ch4og.com>
;; SPDX-License-Identifier: GPL-3.0-or-later
!#

(define-module (maak)
  #:declarative? #t
  #:use-module (maak maak)
  #:use-module (ice-9 match)
  #:use-module (ice-9 ftw))

(define dotfiles-list
  '("btop"
    "dxvk"
    "emacs"
    "fastfetch"
    "fish"
    "ghostty"
    "git"
    "gtk"
    "jujutsu"
    "mangohud"
    "mangowc"
    "pipewire"
    "podman"
    "protonup"
    "rofi"
    "swappy"
    "tmux"
    "waybar"))

(define config-root
  (dirname (canonicalize-path (current-filename))))

(add-to-load-path config-root)

(define (dotfiles)
  "Reconfigure dotfiles"
  (let ((dotfiles-dir (string-append config-root "/dotfiles")))
    (define (run-stow flags target)
      ($ `("cd" ,dotfiles-dir "&&"
           "stow" ,@flags "--dotfiles -t ~" ,target)
         #:verbose? #t))
    (display "Unstowing all dotfiles...\n")
    (run-stow '("-D") "*")
    (display "Stowing selected dotfiles:\n")
    (for-each
     (lambda (dotfile)
       (run-stow '() dotfile))
     dotfiles-list)))

(define (guix-reconfigure type)
  (let ((sudo (if (string=? type "system") "sudo" "")))
    ($ `("cd" ,config-root
         "&&"
         ,sudo
         "guix time-machine -C"
         "koshi/lib/channels.scm"
         "--"
         ,type
         "reconfigure"
         ,(string-append "koshi/" type "/config.scm")
         ,(@ (koshi lib substitutes) %koshi-subs-urls)
         "-L."
         "--allow-downgrades")
       #:verbose? #t)))

(define (fmt)
  "Format Koshi"
  ($ `("find" ,(string-append config-root "/koshi") "-type f -name '*.scm'"
       "-exec emacs --batch {} --eval '(progn (indent-region (point-min) (point-max)) (save-buffer))' \\;")
     #:verbose? #t))

(define (default)
  ($ `(,(current-filename) "--list")
     #:verbose? #t))

(define (update)
  "Update Koshi channels"
  (let* ((input "koshi/lib/channels.template")
         (output "koshi/lib/channels.scm")
         (replacement (string-append "$(guix time-machine --channels=" input " -- describe --format=channels)")))
    ($ `("cd" ,config-root
         "&&"
         ,(string-append "awk -v rep=\"" replacement
                         "\"\\) '/;;; %koshi-chs start/ {print rep; skip=1; next} skip && /;;; %koshi-chs end/ {skip=0; next} !skip {print}' "
                         input
                         " > " output))
       #:verbose? #t)
    ($ `("emacs --batch"
         ,(string-append config-root "/koshi/lib/channels.scm")
         "--eval '(progn (indent-region (point-min) (point-max)) (save-buffer))' \\;")
       #:verbose? #t)))

(define (system)
  "Reconfigure Koshi system"
  (guix-reconfigure "system"))

(define (home)
  "Reconfigure Koshi home"
  (guix-reconfigure "home")
  (nix-switch)
  (dotfiles))

(define (nix-update)
  "Update Bashame channels"
  ($ `("cd" ,(string-append config-root "/bashame") "&& nix flake update")
     #:verbose? #t))

(define (nix-fmt)
  "Format Bashame"
  ($ `("cd" ,(string-append config-root "/bashame") "&& nix fmt .")
     #:verbose? #t))

(define (nix-switch)
  "Reconfigure Bashame"
  ($ `("cd" ,(string-append config-root "/bashame")
       "&& nix run . -- switch --flake .")
     #:verbose? #t))
