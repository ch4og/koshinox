#!/usr/bin/env -S GUILE_AUTO_COMPILE=0 guix shell maak stow -- env -S GUILE_AUTO_COMPILE=0 maak -f
;; -*- mode: scheme -*-
;; SPDX-FileCopyrightText: 2026 Nikita Mitasov <me@ch4og.com>
;; SPDX-License-Identifier: GPL-3.0-or-later
!#

(define-module (maak)
  #:declarative? #t
  #:use-module (maak maak)
  #:use-module (ice-9 match)
  #:use-module (ice-9 ftw))

(define dotfiles-list
  '("btop"
    "dxvk"
    "emacs"
    "fastfetch"
    "fish"
    "foot"
    "ghostty"
    "git"
    "gtk"
    "jujutsu"
    "mangohud"
    "mangowc"
    "pipewire"
    "podman"
    "rofi"
    "ssh"
    "swappy"
    "tmux"
    "waybar"))

(define config-root
  (dirname (canonicalize-path (current-filename))))

(add-to-load-path config-root)

(define (dots)
  "Reconfigure dotfiles"
  (let ((dotfiles-dir (string-append config-root "/dotfiles")))
    (define (run-stow flags target)
      ($ `("cd" ,dotfiles-dir
           "&&"
           "stow"
           ,@flags
           "~"
           ,target)
         #:verbose? #t))
    (display "Unstowing all dotfiles...\n")
    (run-stow '("-D" "--dotfiles" "-t") "*")
    (display "Stowing selected dotfiles:\n")
    (for-each
     (lambda (dotfile)
       (run-stow '("--dotfiles" "-t") dotfile))
     dotfiles-list)))

(define (guix-reconfigure type)
  "Reconfigure Koshi"
  (let* ((time-machine '("sudo" "guix" "time-machine" "-C" "koshi/lib/channels.scm" "--"))
         (guix (if (string=? type "system") time-machine '("guix")))
         (config-file (string-append "koshi/" type "/config.scm"))
         (subs (@ (koshi lib substitutes) %koshi-subs-urls))
         (args `(,subs "-L." "--allow-downgrades")))
    ($ `("cd"
         ,config-root
         "&&"
         ,@guix
         ,type
         "reconfigure"
         ,config-file
         ,@args)
       #:verbose? #t)))

(define (fmt)
  "Format Koshi"
  ($ `("find" ,(string-append config-root "/koshi") "-type f -name '*.scm'"
       "-exec guix style -f {} \\;")
     #:verbose? #t))

(define (default)
  ($ `(,(current-filename) "--list")
     #:verbose? #t))

(define (up)
  "Update Koshi channels"
  (let* ((input "koshi/lib/channels.template")
         (output "koshi/lib/channels.scm")
         (replacement (string-append "$(guix time-machine --channels=" input " -- describe --format=channels)")))
    ($ `("cd" ,config-root
         "&&"
         ,(string-append "awk -v rep=\"" replacement
                         "\"\\) '/;;; %koshi-chs start/ {print rep; skip=1; next} skip && /;;; %koshi-chs end/ {skip=0; next} !skip {print}' "
                         input
                         " > " output))
       #:verbose? #t)
    ($ `("emacs --batch"
         ,(string-append config-root "/koshi/lib/channels.scm")
         "--eval '(progn (indent-region (point-min) (point-max)) (save-buffer))' \\;")
       #:verbose? #t)))

(define (system)
  "Reconfigure Koshi system"
  (guix-reconfigure "system"))

(define (home)
  "Reconfigure Koshi home"
  (guix-reconfigure "home")
  (nix)
  (dots))

(define (nix-up)
  "Update Nix channels"
  ($ `("cd" ,(string-append config-root "/nix") "&& nix flake update")
     #:verbose? #t))

(define (nix-fmt)
  "Format Nix"
  ($ `("cd" ,(string-append config-root "/nix") "&& nix fmt .")
     #:verbose? #t))

(define (nix)
  "Reconfigure Nix"
  ($ `("cd" ,(string-append config-root "/nix")
       "&& nix run . -- switch --flake .")
     #:verbose? #t))
